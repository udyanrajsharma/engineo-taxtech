
  CREATE OR REPLACE FORCE VIEW "APPS"."XXIRIS_GSTR1_HDR_V" ("TXN_TYPE", "ACTUAL_TRX_NUMBER", "TRX_DATE", "TRX_ID", "FP", "GSTIN") AS 
  SELECT DISTINCT
    'PROJECT_INVOICE' TXN_TYPE,
    rcta.TRX_NUMBER ACTUAL_TRX_NUMBER,
    rcta.TRX_DATE TRX_DATE,
    rcta.CUSTOMER_TRX_ID TRX_ID,
    TO_CHAR(rcta.TRX_DATE,'MMYYYY') fp,
    CASE
		WHEN jtl.FIRST_PARTY_PRIMARY_REG_NUM = '29AABCM3722F1Z0' THEN '29ABCDE9876A1ZE'
		WHEN jtl.FIRST_PARTY_PRIMARY_REG_NUM = '24AABCM3722F1ZY' THEN '24ABCDE9876A1ZE'
        WHEN jtl.FIRST_PARTY_PRIMARY_REG_NUM = '10AABCM3722F1Z7' THEN '10ABCDE9876A1ZI'
        
        WHEN jtl.FIRST_PARTY_PRIMARY_REG_NUM = '36AABCM3722F1ZT' THEN '36ABCDE9876A1ZE'
        WHEN jtl.FIRST_PARTY_PRIMARY_REG_NUM = '09AABCM3722F1ZQ' THEN '09ABCDE9876A1ZE'
        WHEN jtl.FIRST_PARTY_PRIMARY_REG_NUM = '27AABCM3722F1ZS' THEN '27ABCDE9876A1ZE'
        WHEN jtl.FIRST_PARTY_PRIMARY_REG_NUM = '37AABCM3722F1ZR' THEN '37ABCDE9876A1ZE'
		ELSE jtl.FIRST_PARTY_PRIMARY_REG_NUM
	END gstin
FROM
    RA_CUSTOMER_TRX_ALL rcta,
    HR_ALL_ORGANIZATION_UNITS hrou,
    RA_CUST_TRX_TYPES_ALL rctta,
    RA_CUSTOMER_TRX_LINES_ALL rctla,
    JAI_TAX_LINES_ALL jtl,
    JAI_TAX_DET_FACTORS jtdf,
    JAI_TAX_RATES jtr,
    JAI_REGIMES jr,
    (SELECT 
        hca.CUST_ACCOUNT_ID, 
        hcas.CUST_ACCT_SITE_ID, 
        hcsu.SITE_USE_ID,
        hp.PARTY_ID,
        hp.PARTY_NAME,
        hp.PARTY_NUMBER,
        hzl.ADDRESS1,
        hzl.ADDRESS2,
        hzl.CITY,
        hzl.STATE,
        REGEXP_REPLACE(hzl.POSTAL_CODE, '[^0-9]', '') POSTAL_CODE,
        (
        SELECT
           NVL( MIN(jprl.REGISTRATION_NUMBER) , 'X')
        FROM
            JAI_PARTY_REG_LINES jprl
        WHERE 1=1
            AND jprl.PARTY_REG_ID = jpr.PARTY_REG_ID
            AND NVL(jprl.EFFECTIVE_TO, SYSDATE) >= SYSDATE
            AND UPPER(jprl.REGISTRATION_TYPE_CODE) = 'GST'
        ) BUYER_GSTIN
    FROM
        HZ_CUST_ACCOUNTS_ALL hca,
        HZ_PARTIES hp,
        HZ_CUST_ACCT_SITES_ALL hcas,
        HZ_PARTY_SITES hps,
        HZ_CUST_SITE_USES_ALL hcsu,
        HZ_LOCATIONS hzl,
        JAI_PARTY_REGS jpr
    WHERE 1=1
        AND hca.PARTY_ID = hp.PARTY_ID
        AND hca.CUST_ACCOUNT_ID = hcas.CUST_ACCOUNT_ID
        AND hp.PARTY_ID = hps.PARTY_ID
        AND hcas.PARTY_SITE_ID = hps.PARTY_SITE_ID
        AND hcas.CUST_ACCT_SITE_ID = hcsu.CUST_ACCT_SITE_ID
        AND hcsu.SITE_USE_CODE = 'BILL_TO'
        AND hcsu.STATUS = 'A'
        AND hps.LOCATION_ID = hzl.LOCATION_ID
        AND hca.CUST_ACCOUNT_ID = jpr.PARTY_ID
        AND hcas.CUST_ACCT_SITE_ID = jpr.PARTY_SITE_ID
        AND UPPER(jpr.PARTY_TYPE_CODE) IN ( 'THIRD_PARTY', 'THIRD_PARTY_SITE' )
    ) buyer_dtls,
    (SELECT
        hrl.LOCATION_ID,
        hrl.ADDRESS_LINE_1 ADDRESS1,
        hrl.ADDRESS_LINE_2 ADDRESS2,
        hrl.LOC_INFORMATION15 CITY,
        hrl.LOC_INFORMATION16 STATE,
        REGEXP_REPLACE(hrl.POSTAL_CODE, '[^0-9]', '') POSTAL_CODE
    FROM
        HR_LOCATIONS hrl
    WHERE 1 = 1
        ) seller_dtls
WHERE 1=1
--    AND rcta.TRX_DATE BETWEEN TO_DATE(:p_from_date,'DD-MON-YYYY') AND TO_DATE(:p_to_date,'DD-MON-YYYY')
    AND rcta.ORG_ID = hrou.ORGANIZATION_ID
    AND rcta.CUSTOMER_TRX_ID = rctla.CUSTOMER_TRX_ID
    AND rctla.LINE_TYPE = 'LINE'
    AND rcta.CUST_TRX_TYPE_ID = rctta.CUST_TRX_TYPE_ID
    AND rcta.ORG_ID = rctta.ORG_ID
    AND rcta.CUSTOMER_TRX_ID = jtl.TRX_ID
    AND rctla.CUSTOMER_TRX_LINE_ID = jtl.TRX_LINE_ID
    AND jtl.ENTITY_CODE = 'TRANSACTIONS'
    AND jtl.EVENT_CLASS_CODE IN ('INVOICE','CREDIT_MEMO','DEBIT_MEMO')
    AND jtl.FIRST_PARTY_PRIMARY_REG_NUM IS NOT NULL
    AND jtl.DET_FACTOR_ID = jtdf.DET_FACTOR_ID
    AND jtl.TAX_RATE_ID = jtr.TAX_RATE_ID
    AND jtr.REGIME_ID = jr.REGIME_ID
    AND rcta.BILL_TO_CUSTOMER_ID = buyer_dtls.CUST_ACCOUNT_ID
    AND jtl.LOCATION_ID = seller_dtls.LOCATION_ID

UNION ALL

SELECT DISTINCT
    'PAYABLES_REVERSAL' TXN_TYPE,
    aia.INVOICE_NUM ACTUAL_TRX_NUMBER,
    aia.INVOICE_DATE TRX_DATE,
    aia.INVOICE_ID TRX_ID,
    TO_CHAR(aia.INVOICE_DATE,'MMYYYY') fp,
    CASE
		WHEN seller_dtls.SELLER_GSTIN = '29AABCM3722F1Z0' THEN '29ABCDE9876A1ZE'
		WHEN seller_dtls.SELLER_GSTIN = '24AABCM3722F1ZY' THEN '24ABCDE9876A1ZE'
        WHEN seller_dtls.SELLER_GSTIN = '10AABCM3722F1Z7' THEN '10ABCDE9876A1ZI'
        WHEN seller_dtls.SELLER_GSTIN = '36AABCM3722F1ZT' THEN '36ABCDE9876A1ZE'
        WHEN seller_dtls.SELLER_GSTIN = '09AABCM3722F1ZQ' THEN '09ABCDE9876A1ZE'
        WHEN seller_dtls.SELLER_GSTIN = '27AABCM3722F1ZS' THEN '27ABCDE9876A1ZE'
        WHEN seller_dtls.SELLER_GSTIN = '37AABCM3722F1ZR' THEN '37ABCDE9876A1ZE'
		ELSE seller_dtls.SELLER_GSTIN
	END gstin
FROM
    AP_INVOICES_ALL aia,
    AP_INVOICE_LINES_ALL aila,
    JAI_TAX_LINES jtl,
    JAI_TAX_DET_FACTORS jtdf,
    JAI_TAX_RATES jtr,
    JAI_REGIMES jr,
    (SELECT 
        aps.VENDOR_ID,
        aps.VENDOR_NAME,
        apss.VENDOR_SITE_ID,
        (SELECT jprl.REGISTRATION_NUMBER
        FROM    
            JAI_PARTY_REGS jpr,
            JAI_PARTY_REG_LINES jprl
        WHERE 1=1
            AND aps.VENDOR_ID = jpr.PARTY_ID
            AND apss.VENDOR_SITE_ID = jpr.PARTY_SITE_ID
            AND jpr.PARTY_TYPE_CODE IN ('THIRD_PARTY_SITE','THIRD_PARTY')
            AND jpr.PARTY_REG_ID = jprl.PARTY_REG_ID
            AND jprl.REGISTRATION_TYPE_CODE = 'GST'
            AND ROWNUM = 1
        ) BUYER_GSTIN,
        hzl.LOCATION_ID,
        hzl.ADDRESS1,
        hzl.ADDRESS2,
        hzl.CITY,
        hzl.STATE,
        REGEXP_REPLACE(hzl.POSTAL_CODE, '[^0-9]', '') POSTAL_CODE
    FROM 
        AP_SUPPLIERS aps,
        AP_SUPPLIER_SITES_ALL apss,
        HZ_LOCATIONS hzl
    WHERE 1=1
        AND aps.VENDOR_ID = apss.VENDOR_ID
        AND apss.LOCATION_ID = hzl.LOCATION_ID
    ) buyer_dtls,
    (SELECT DISTINCT
        (SELECT jprl.REGISTRATION_NUMBER
        FROM
            JAI_PARTY_REGS jpr,
            JAI_PARTY_REG_LINES jprl
        WHERE 1=1
            AND hrl.INVENTORY_ORGANIZATION_ID = jpr.PARTY_ID
            AND hrl.LOCATION_ID = jpr.PARTY_SITE_ID
            AND jpr.PARTY_REG_ID = jprl.PARTY_REG_ID
            AND jpr.PARTY_TYPE_CODE = 'IO'
            AND jprl.REGISTRATION_TYPE_CODE = 'GST'
            AND ROWNUM = 1
        ) SELLER_GSTIN,
        (SELECT 
            hraou.NAME
        FROM 
            HR_ALL_ORGANIZATION_UNITS hraou
        WHERE 
            hrl.INVENTORY_ORGANIZATION_ID = hraou.ORGANIZATION_ID
        ) SELLER_NAME,
        hrl.INVENTORY_ORGANIZATION_ID,
        hrl.LOCATION_ID,
        SUBSTR(LOCATION_CODE,0,INSTR(LOCATION_CODE,'-',1) - 1) LOCATION_CODE,
        hrl.ADDRESS_LINE_1,
        hrl.ADDRESS_LINE_2,
        hrl.LOC_INFORMATION15 CITY,
        (SELECT flv.DESCRIPTION
        FROM
            JAI_PARTY_REGS jpr,
            JAI_PARTY_REG_LINES jprl,
            FND_LOOKUP_VALUES flv
        WHERE 1=1
            AND hrl.INVENTORY_ORGANIZATION_ID = jpr.PARTY_ID
            AND hrl.LOCATION_ID = jpr.PARTY_SITE_ID
            AND jpr.PARTY_REG_ID = jprl.PARTY_REG_ID
            AND jpr.PARTY_TYPE_CODE = 'IO'
            AND jprl.REGISTRATION_TYPE_CODE = 'GST'
            AND flv.LOOKUP_TYPE = 'GST STATE LOOKUP'
            AND flv.LOOKUP_CODE = SUBSTR(jprl.REGISTRATION_NUMBER,0,2)
            AND ROWNUM = 1
        ) STATE,
        REGEXP_REPLACE(hrl.POSTAL_CODE, '[^0-9]', '') POSTAL_CODE
    FROM 
        HR_LOCATIONS hrl
    WHERE 1=1
    ) seller_dtls
WHERE 1=1
--    AND aia.INVOICE_DATE BETWEEN TO_DATE(:p_from_date,'DD-MON-YYYY') AND TO_DATE(:p_to_date,'DD-MON-YYYY')
    AND aia.INVOICE_ID = jtl.TRX_ID
    AND aia.INVOICE_ID = aila.INVOICE_ID
    AND aila.LINE_NUMBER = jtl.TRX_LINE_ID
    AND aila.LINE_TYPE_LOOKUP_CODE = 'ITEM'
    AND aia.VENDOR_ID = buyer_dtls.VENDOR_ID
    AND aia.VENDOR_SITE_ID = buyer_dtls.VENDOR_SITE_ID
    AND jtl.LOCATION_ID = seller_dtls.LOCATION_ID
    AND aia.CANCELLED_DATE IS NULL
    AND jtl.TRX_TYPE IN ('CREDIT','DEBIT')
    AND jtl.TAX_RATE_ID NOT IN ('23091','33833','33894','23070','23090','33853','33893')
    AND jtl.TAX_REGIME_CODE <>'RCM'
    AND jtl.DET_FACTOR_ID = jtdf.DET_FACTOR_ID
    AND jtl.TAX_RATE_ID = jtr.TAX_RATE_ID
    AND jtr.REGIME_ID = jr.REGIME_ID

UNION ALL

SELECT DISTINCT
    'STOCK_TRANSFER' TXN_TYPE,
    NVL(rsh.SHIPMENT_NUM, jtdf.TAX_INVOICE_NUM) ACTUAL_TRX_NUMBER,
    rsh.SHIPPED_DATE TRX_DATE,
    rsh.SHIPMENT_HEADER_ID TRX_ID,
    TO_CHAR(rsh.SHIPPED_DATE,'MMYYYY') fp,
    CASE
		WHEN seller_dtls.SELLER_GSTIN IN ('29AABCM3722F1Z0','29AABCM3722F1ZO') THEN '29ABCDE9876A1ZE'
		WHEN seller_dtls.SELLER_GSTIN = '24AABCM3722F1ZY' THEN '24ABCDE9876A1ZE'
        WHEN seller_dtls.SELLER_GSTIN = '10AABCM3722F1Z7' THEN '10ABCDE9876A1ZI'
        WHEN seller_dtls.SELLER_GSTIN = '36AABCM3722F1ZT' THEN '36ABCDE9876A1ZE'
        WHEN seller_dtls.SELLER_GSTIN = '09AABCM3722F1ZQ' THEN '09ABCDE9876A1ZE'
        WHEN seller_dtls.SELLER_GSTIN = '27AABCM3722F1ZS' THEN '27ABCDE9876A1ZE'
        WHEN seller_dtls.SELLER_GSTIN = '37AABCM3722F1ZR' THEN '37ABCDE9876A1ZE'
		ELSE seller_dtls.SELLER_GSTIN
	END gstin
FROM 
    RCV_SHIPMENT_HEADERS rsh,
    RCV_SHIPMENT_LINES rsl,
    RCV_TRANSACTIONS rcv,
    JAI_TAX_LINES_ALL jtl,
    JAI_TAX_DET_FACTORS jtdf,
    JAI_TAX_RATES jtr,
    JAI_REGIMES jr,
    MTL_MATERIAL_TRANSACTIONS mtt,
    (SELECT 
        hrl.ORGANIZATION_ID ORG_ID,
        ood.ORGANIZATION_NAME PARTY_NAME,
        hrl.LOCATION_CODE,
        hrl.ADDRESS_LINE_1,
        hrl.ADDRESS_LINE_2,
        hrl.ADDRESS_LINE_3,
        hrl.POSTAL_CODE,
        hrl.LOC_INFORMATION15 CITY,
        jpr.PARTY_ID,
        jprl.REGISTRATION_NUMBER SELLER_GSTIN
    FROM
        ORG_ORGANIZATION_DEFINITIONS ood,
        HR_ORGANIZATION_UNITS_V hrl,
        JAI_PARTY_REGS jpr,
        JAI_PARTY_REG_LINES jprl
    WHERE 1=1
        AND ood.ORGANIZATION_ID = hrl.ORGANIZATION_ID
        AND ood.ORGANIZATION_ID = jpr.PARTY_ID
        AND jpr.PARTY_REG_ID = jprl.PARTY_REG_ID
    ) seller_dtls,
    (SELECT 
        hrl.INVENTORY_ORGANIZATION_ID ORG_ID,
        hou.NAME PARTY_NAME,
        hrl.ADDRESS_LINE_1,
        hrl.ADDRESS_LINE_2,
        hrl.ADDRESS_LINE_3,
        hrl.POSTAL_CODE,
        hrl.LOC_INFORMATION15 CITY,
        jprl.REGISTRATION_NUMBER BUYER_GSTIN
    FROM
        HR_LOCATIONS hrl,
        JAI_PARTY_REGS jpr,
        JAI_PARTY_REG_LINES jprl,
        HR_ORGANIZATION_UNITS hou
    WHERE 1=1
        AND hrl.INVENTORY_ORGANIZATION_ID = jpr.PARTY_ID
        AND jpr.PARTY_REG_ID = jprl.PARTY_REG_ID
        AND hrl.INVENTORY_ORGANIZATION_ID = hou.ORGANIZATION_ID
        AND jpr.PARTY_TYPE_CODE = 'IO' 
        AND jprl.EFFECTIVE_TO IS NULL
        AND jprl.REGIME_ID = '10000'
    ) buyer_dtls
WHERE 1=1
--    AND rcv.TRANSACTION_DATE BETWEEN TO_DATE(:p_from_date,'DD-MON-YYYY') AND TO_DATE(:p_to_date,'DD-MON-YYYY')
    AND rsh.SHIPMENT_HEADER_ID = rsl.SHIPMENT_HEADER_ID
    AND rsl.SHIPMENT_LINE_ID = rcv.SHIPMENT_LINE_ID
    AND rcv.TRANSACTION_ID = mtt.RCV_TRANSACTION_ID
    AND rcv.SOURCE_DOCUMENT_CODE = 'INVENTORY'
    AND rcv.TRANSACTION_TYPE = 'DELIVER'
    AND NOT EXISTS (
        SELECT rcv2.SHIPMENT_HEADER_ID 
        FROM RCV_TRANSACTIONS rcv2 
        WHERE rcv2.TRANSACTION_TYPE LIKE 'RETURN TO%' 
        AND rcv2.SHIPMENT_HEADER_ID = rsh.SHIPMENT_HEADER_ID
    )
    AND rcv.TRANSACTION_ID = jtl.TRX_LOC_LINE_ID
    AND jtl.ROUNDED_TAX_AMT_FUN_CURR IS NOT NULL
    AND jtl.DET_FACTOR_ID = jtdf.DET_FACTOR_ID
    AND jtl.TAX_RATE_ID = jtr.TAX_RATE_ID
    AND jtr.REGIME_ID = jr.REGIME_ID
    AND rsh.ORGANIZATION_ID = seller_dtls.ORG_ID
    AND rsh.SHIP_TO_ORG_ID = buyer_dtls.ORG_ID;

